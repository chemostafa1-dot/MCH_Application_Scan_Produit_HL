    
<!DOCTYPE html>
<html lang="fr">
<head>

    <link rel="manifest" href="manifest.json">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan & Check - Ultimate</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .verdict-box { transition: all 0.4s ease; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-bold"><i class="fas fa-qrcode mr-2"></i>Scan & Check</h1>
            <button onclick="resetApp()" class="text-sm bg-indigo-500 hover:bg-indigo-700 px-3 py-1 rounded"><i class="fas fa-redo"></i> Reset</button>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto">
        
        <!-- CONFIGURATION DU REGIME -->
        <div id="config-section" class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="diet-select">
                Je recherche un produit :
            </label>
            <div class="relative">
                <select id="diet-select" onchange="updatePreference()" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline text-gray-700 font-bold">
                    <option value="none">ü•ó Standard (Tout afficher)</option>
                    <option value="vegetarian">ü•¶ V√©g√©tarien</option>
                    <option value="vegan">üå± V√©gan</option>
                    <option value="halal">‚ò™Ô∏è Halal</option>
                    <option value="kosher">‚ú°Ô∏è Casher</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </div>

        <!-- ZONE DE SCAN -->
        <div id="scan-section" class="mb-6">
            <div class="bg-white p-4 rounded-xl shadow-md">
                <div id="reader" class="bg-black min-h-[250px]"></div>
                <p id="status" class="text-center text-sm text-gray-500 mt-3 font-medium animate-pulse">Pointez la cam√©ra vers un code-barre</p>
            </div>
        </div>

        <!-- RESULTATS -->
        <div id="result-section" class="hidden">
            
            <!-- 1. VERDICT PRINCIPAL -->
            <div id="verdict-card" class="bg-gray-100 rounded-xl shadow-lg p-5 mb-6 text-center border-4 border-gray-300 verdict-box">
                <div id="verdict-icon" class="text-5xl mb-2 text-gray-400"><i class="fas fa-question-circle"></i></div>
                <h2 id="verdict-title" class="text-2xl font-bold uppercase mb-1">Analyse...</h2>
                <p id="verdict-reason" class="text-lg font-medium"></p>
            </div>

            <!-- 2. DETAILS PRODUIT -->
            <div class="bg-white rounded-xl shadow overflow-hidden mb-6">
                <div class="flex p-4">
                    <img id="product-img" src="" class="w-24 h-24 object-contain rounded border border-gray-100 bg-gray-50">
                    <div class="ml-4 flex-1">
                        <h3 id="product-name" class="font-bold text-gray-800 text-lg leading-tight mb-1">Produit</h3>
                        <p id="product-brand" class="text-sm text-gray-500 mb-2">Marque</p>
                        <div id="nutriscore" class="inline-block px-2 py-0.5 rounded text-xs font-bold text-white bg-gray-400">SCORE ?</div>
                    </div>
                </div>
            </div>

            <!-- 3. PRIX ALENTOURS -->
            <div class="bg-white rounded-xl shadow p-4 mb-20">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fas fa-store-alt mr-2 text-indigo-500"></i>Prix moyens d√©tect√©s</h3>
                <div id="prices-list" class="space-y-2"></div>
                <p class="text-xs text-gray-400 mt-2 text-center italic">Prix simul√©s bas√©s sur la localisation locale.</p>
            </div>
        </div>

        <!-- Bouton Flottant Scanner Nouveau -->
        <div id="fab-retry" class="fixed bottom-6 left-0 right-0 text-center hidden z-50">
            <button onclick="resetApp()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-xl hover:bg-indigo-700 transform transition hover:scale-105">
                <i class="fas fa-barcode mr-2"></i>Scanner un autre
            </button>
        </div>

    </main>

    <script>
        // --- CONFIGURATION & DONNEES ---
        const html5QrcodeScanner = new Html5Qrcode("reader");
        let userPreference = 'none'; // Par d√©faut
        
        // Dictionnaires de mots-cl√©s interdits par r√©gime
        // Pour un vrai produit commercial, ces listes devraient √™tre bien plus exhaustives
        const FORBIDDEN_RULES = {
            vegetarian: {
                labels: ['vegetarian', 'vegan'], // Si ces labels sont pr√©sents, c'est OK direct
                keywords: [
                    { term: 'porc', name: 'Porc' }, { term: 'pork', name: 'Porc' },
                    { term: 'boeuf', name: 'B≈ìuf' }, { term: 'beef', name: 'B≈ìuf' },
                    { term: 'poulet', name: 'Poulet' }, { term: 'chicken', name: 'Poulet' },
                    { term: 'viande', name: 'Viande' }, { term: 'meat', name: 'Viande' },
                    { term: 'poisson', name: 'Poisson' }, { term: 'fish', name: 'Poisson' },
                    { term: 'g√©latine', name: 'G√©latine' }, { term: 'gelatine', name: 'G√©latine' },
                    { term: 'e441', name: 'G√©latine (E441)' }, { term: 'e120', name: 'Carmin (E120)' }
                ]
            },
            vegan: {
                labels: ['vegan'],
                keywords: [
                    { term: 'lait', name: 'Lait' }, { term: 'milk', name: 'Lait' },
                    { term: 'beurre', name: 'Beurre' }, { term: 'butter', name: 'Beurre' },
                    { term: 'oeuf', name: '≈íuf' }, { term: 'egg', name: '≈íuf' },
                    { term: 'miel', name: 'Miel' }, { term: 'honey', name: 'Miel' },
                    { term: 'lactos', name: 'Lactose' }, { term: 'casein', name: 'Cas√©ine' },
                    { term: 'e901', name: 'Cire d\'abeille' },
                    // Inclut aussi tout ce qui est v√©g√©tarien
                    { term: 'porc', name: 'Porc' }, { term: 'viande', name: 'Viande' }, 
                    { term: 'poisson', name: 'Poisson' }, { term: 'g√©latine', name: 'G√©latine' }, 
                    { term: 'e120', name: 'Carmin (E120)' }
                ]
            },
            halal: {
                labels: ['halal'],
                keywords: [
                    { term: 'porc', name: 'Porc' }, { term: 'pork', name: 'Porc' },
                    { term: 'jambon', name: 'Jambon' }, { term: 'lardon', name: 'Lardon' },
                    { term: 'bacon', name: 'Bacon' }, { term: 'saucisson', name: 'Saucisson' },
                    { term: 'alcool', name: 'Alcool' }, { term: 'alcohol', name: 'Alcool' },
                    { term: 'vin ', name: 'Vin' }, { term: 'rhum', name: 'Rhum' },
                    { term: 'g√©latine', name: 'G√©latine' }, { term: 'e441', name: 'G√©latine' },
                    { term: 'e120', name: 'Carmin (E120)' },
                    { term: 'graisse animale', name: 'Graisse animale' }
                ]
            },
            kosher: {
                labels: ['kosher', 'casher'],
                keywords: [
                    { term: 'porc', name: 'Porc' }, { term: 'pork', name: 'Porc' },
                    { term: 'jambon', name: 'Jambon' }, { term: 'lardon', name: 'Lardon' },
                    { term: 'crevette', name: 'Fruits de mer' }, { term: 'shrimp', name: 'Fruits de mer' },
                    { term: 'crustac', name: 'Crustac√©s' }, { term: 'moule', name: 'Moule' },
                    { term: 'huitre', name: 'Hu√Ætre' }, { term: 'calamar', name: 'Calamar' },
                    { term: 'g√©latine', name: 'G√©latine' }, { term: 'e441', name: 'G√©latine' },
                    { term: 'e120', name: 'Carmin (E120)' }
                    // Note : Le m√©lange Lait/Viande est trop complexe √† v√©rifier par simple scan de mots-cl√©s
                ]
            }
        };

        // --- FONCTIONS PRINCIPALES ---

        function updatePreference() {
            userPreference = document.getElementById('diet-select').value;
            console.log("Pr√©f√©rence mise √† jour : " + userPreference);
        }

        function startScanner() {
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch(err => {
                console.error("Erreur camera", err);
                document.getElementById('status').innerText = "Erreur : Impossible d'acc√©der √† la cam√©ra. V√©rifiez que vous √™tes en HTTPS.";
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
                document.getElementById('status').innerText = "Code d√©tect√© ! Analyse en cours...";
                fetchProductData(decodedText);
            });
        }

        function onScanFailure(error) {} // Silence is golden

        async function fetchProductData(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                if (data.status === 1) {
                    displayProduct(data.product);
                } else {
                    alert("Produit inconnu !");
                    resetApp();
                }
            } catch (error) {
                alert("Erreur r√©seau.");
                resetApp();
            }
        }

        function displayProduct(product) {
            // Affichage UI de base
            document.getElementById('scan-section').classList.add('hidden');
            document.getElementById('config-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('fab-retry').classList.remove('hidden');

            document.getElementById('product-name').innerText = product.product_name || "Nom inconnu";
            document.getElementById('product-brand').innerText = product.brands || "Marque inconnue";
            document.getElementById('product-img').src = product.image_url || "https://via.placeholder.com/150";
            
            const score = product.nutriscore_grade ? product.nutriscore_grade.toUpperCase() : "?";
            const scoreEl = document.getElementById('nutriscore');
            scoreEl.innerText = `Nutri-Score ${score}`;
            
            // Couleurs Nutriscore
            const colors = { 'A': 'bg-green-500', 'B': 'bg-green-400', 'C': 'bg-yellow-500', 'D': 'bg-orange-500', 'E': 'bg-red-500' };
            scoreEl.className = `inline-block px-2 py-0.5 rounded text-xs font-bold text-white ${colors[score] || 'bg-gray-400'}`;

            // --- COEUR DU SYSTEME : L'ANALYSE ---
            analyzeCompliance(product);

            // Simulation Prix
            simulatePrices();
        }

        function analyzeCompliance(product) {
            const card = document.getElementById('verdict-card');
            const title = document.getElementById('verdict-title');
            const reason = document.getElementById('verdict-reason');
            const icon = document.getElementById('verdict-icon');

            // Reset styles
            card.className = "rounded-xl shadow-lg p-5 mb-6 text-center border-4 verdict-box";
            
            // Si aucun r√©gime s√©lectionn√©
            if (userPreference === 'none') {
                card.classList.add('border-blue-200', 'bg-blue-50');
                title.innerText = "Produit identifi√©";
                title.className = "text-2xl font-bold text-blue-800";
                reason.innerText = "Aucun filtre de r√©gime activ√©.";
                icon.innerHTML = '<i class="fas fa-info-circle text-blue-400"></i>';
                return;
            }

            const ingredientsText = (product.ingredients_text || "").toLowerCase();
            const labelsText = (product.labels || "").toLowerCase();
            
            const rules = FORBIDDEN_RULES[userPreference];
            let isSafe = true;
            let conflictReason = "";

            // 1. V√©rification positive (Labels officiels)
            // Si le produit a un label officiel (ex: Label Vegan sur le paquet), on fait confiance
            const hasSafeLabel = rules.labels.some(label => labelsText.includes(label));

            if (hasSafeLabel) {
                setVerdict("SAFE", "Certifi√© " + userPreference.charAt(0).toUpperCase() + userPreference.slice(1));
                return;
            }

            // 2. V√©rification n√©gative (Ingr√©dients interdits)
            // On scanne chaque mot interdit
            for (let item of rules.keywords) {
                // On v√©rifie si le mot est pr√©sent
                // Utilisation de regex simple pour √©viter les faux positifs partiels si n√©cessaire
                if (ingredientsText.includes(item.term)) {
                    isSafe = false;
                    conflictReason = item.name;
                    
                    // Cas sp√©cial G√©latine : si c'est pr√©cis√© "v√©g√©tal", c'est bon
                    if (item.term.includes('g√©latine') || item.term.includes('gelatine')) {
                        if (ingredientsText.includes('g√©latine v√©g√©tale') || ingredientsText.includes('gelatine vegetale')) {
                            isSafe = true; // Fausse alerte
                            continue; 
                        }
                    }
                    break; // On arr√™te d√®s qu'on trouve un interdit
                }
            }

            if (isSafe) {
                setVerdict("SAFE", "Semble compatible " + userPreference);
            } else {
                setVerdict("DANGER", conflictReason);
            }

            function setVerdict(status, text) {
                if (status === "SAFE") {
                    card.classList.add('border-green-400', 'bg-green-50');
                    title.innerText = "COMPATIBLE";
                    title.className = "text-2xl font-bold text-green-700";
                    reason.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
                    icon.innerHTML = '<i class="fas fa-smile text-green-500"></i>';
                } else {
                    card.classList.add('border-red-500', 'bg-red-50', 'shake');
                    title.innerText = "NON COMPATIBLE";
                    title.className = "text-2xl font-bold text-red-700";
                    reason.innerHTML = `Contient : <strong>${text}</strong>`;
                    icon.innerHTML = '<i class="fas fa-ban text-red-500"></i>';
                    
                    // Vibre si sur mobile
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }
            }
        }

        function simulatePrices() {
            const container = document.getElementById('prices-list');
            container.innerHTML = '';
            const stores = [
                {n: "Carrefour", d: "600m"}, {n: "Leclerc", d: "1.1km"}, 
                {n: "Lidl", d: "2km"}, {n: "Casino", d: "450m"}
            ];
            const base = (Math.random() * 5 + 1).toFixed(2);
            
            stores.forEach(s => {
                const p = (parseFloat(base) + (Math.random() - 0.5)).toFixed(2);
                const color = p < base ? 'text-green-600' : 'text-gray-700';
                container.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b border-gray-100 last:border-0">
                        <div><span class="font-semibold">${s.n}</span> <span class="text-xs text-gray-400">(${s.d})</span></div>
                        <div class="font-bold ${color}">${p} ‚Ç¨</div>
                    </div>`;
            });
        }

        function resetApp() {
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('fab-retry').classList.add('hidden');
            document.getElementById('scan-section').classList.remove('hidden');
            document.getElementById('config-section').classList.remove('hidden');
            document.getElementById('reader').style.display = 'block';
            document.getElementById('status').innerText = "Pointez la cam√©ra vers un code-barre";
            startScanner();
        }

        // Lancement
        startScanner();
    </script>
</body>
</html>

  